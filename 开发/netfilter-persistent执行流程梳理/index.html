<!doctype html><html lang=zh-cn><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>netfilter-persistent.service 执行流程梳理 - 乐土为家</title>
<meta name=description content="配置Oracle VPS的防火墙时遇到了问题，所以顺便看一下。用的时间太长了，这种岔开的细事要先不求甚解。 netfilter-persistent.service 做了什么 graph TD; z[?]--a a[&#34;/lib/systemd/system/netfilter-persistent.service&#34;] -- b[`/usr/sbin/netfilter-persistent start``/usr/sbin/netfilter-persistent stop`] b -- |default config| c1[&#34;/etc/default/netfilter-persistent&#34;]">
<link rel=canonical href=https://475300.github.io/%E5%BC%80%E5%8F%91/netfilter-persistent%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/>
<meta property="og:title" content="netfilter-persistent.service 执行流程梳理">
<meta property="og:type" content="article">
<meta property="og:url" content="https://475300.github.io/%E5%BC%80%E5%8F%91/netfilter-persistent%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/">
<meta property="og:description" content="配置Oracle VPS的防火墙时遇到了问题，所以顺便看一下。用的时间太长了，这种岔开的细事要先不求甚解。 netfilter-persistent.service 做了什么 graph TD; z[?]--a a[&#34;/lib/systemd/system/netfilter-persistent.service&#34;] -- b[`/usr/sbin/netfilter-persistent start``/usr/sbin/netfilter-persistent stop`] b -- |default config| c1[&#34;/etc/default/netfilter-persistent&#34;]">
<meta property="og:site_name" content="乐土为家">
<link rel=stylesheet href=https://475300.github.io/css/main.min.46626abaa02257c4c323c7d2f1f872e4a75032f4ab4bea8ceb62daf52bfc81a2.css integrity="sha256-RmJquqAiV8TDI8fS8fhy5KdQMvSrS+qM62La9Sv8gaI=">
<meta name=generator content="Hugo 0.86.1">
<script type=module src=https://unpkg.com/ionicons@5.1.2/dist/ionicons/ionicons.esm.js></script>
<script nomodule src=https://unpkg.com/ionicons@5.1.2/dist/ionicons/ionicons.js></script>
</head>
<body><header class=site-header>
<nav class=site-nav role=navigation aria-label=breadcrumb>
<ol itemscope itemtype=https://schema.org/BreadcrumbList class=breadcrumb><li class=breadcrumb-item itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem>
<a itemtype=https://schema.org/Thing itemprop=item href=https://475300.github.io/>
<span itemprop=name>乐土为家</span>
</a>
<meta itemprop=position content="0">
</li>/<li class=breadcrumb-item itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem>
<a itemtype=https://schema.org/Thing itemprop=item href=https://475300.github.io/%E5%BC%80%E5%8F%91/>
<span itemprop=name>开发</span>
</a>
<meta itemprop=position content="0">
</li>/<li class="breadcrumb-item active hidden" aria-current=page itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem>
<a itemtype=https://schema.org/Thing itemprop=item href=https://475300.github.io/%E5%BC%80%E5%8F%91/netfilter-persistent%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/>
<span itemprop=name>netfilter-persistent.service 执行流程梳理</span>
</a>
<meta itemprop=position content="1">
</li></ol>
</nav>
<h1 class="site-title hidden">
<a href=https://475300.github.io/>乐土为家</a>
</h1>
</header>
<main id=content>
<article role=article class="content post h-entry" itemscope itemtype=http://schema.org/BlogPosting>
<header class=post-header>
<h2 class=post-title itemprop="name headline">netfilter-persistent.service 执行流程梳理</h2>
<span class=post-meta>
<time class=date-published datetime=2021-05-24T22:16:29+07:00 itemprop=datePublished>
2021.5.24，星期一
</time>
<span>
<ul id=authors>
<li> <a href=https://475300.github.io/authors/enel>@enel</a> </li>
</ul>
<ul id=tags>
<li> <a href=https://475300.github.io/tags/linux>#Linux</a> </li>
<li> <a href=https://475300.github.io/tags/ubuntu>#Ubuntu</a> </li>
<li> <a href=https://475300.github.io/tags/iptables>#iptables</a> </li>
<li> <a href=https://475300.github.io/tags/systemd>#systemd</a> </li>
<li> <a href=https://475300.github.io/tags/%E9%98%B2%E7%81%AB%E5%A2%99>#防火墙</a> </li>
<li> <a href=https://475300.github.io/tags/todo>#todo</a> </li>
</ul>
</span>
</span>
</header>
<div class=post-content itemprop=articleBody>
<p><a href=http://localhost:1313/%E5%BC%80%E5%8F%91/%E9%85%8D%E7%BD%AEoracle-vps/#%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99 target=_blank rel="nofollow noreferrer noopener">配置Oracle VPS的防火墙</a>时遇到了问题，所以顺便看一下。用的时间太长了，这种岔开的细事要先不求甚解。</p>
<h2 id=netfilter-persistentservice-做了什么>netfilter-persistent.service 做了什么</h2>
<script async src=https://unpkg.com/mermaid@8.10.1/dist/mermaid.min.js></script>
<div class=mermaid>
graph TD;
z[?]-->a
a["/lib/systemd/system/netfilter-persistent.service"] --> b[`/usr/sbin/netfilter-persistent start`<br>`/usr/sbin/netfilter-persistent stop`]
b --> |default config| c1["/etc/default/netfilter-persistent"]
b --> c2["/usr/share/netfilter-persistent/plugins.d"]
c2 --> d1["./15-ip4tables"]
c2 --> d2["./25-ip6tables"]
d1 --> e[`iptables-restore < /etc/iptables/rules.v4`<br>`iptables-save > /etc/iptables/rules.v4`<br>`iptables -F`<br>...<br>]
d2 --> e
</div>
<h2 id=netfilter-persistentservice-是如何启动的>netfilter-persistent.service 是如何启动的</h2>
<p><code>tldr systemd-analyze</code> 列出了四个命令，</p>
<pre><code>➜  ~ tldr systemd-analyze
systemd-analyze
Show timing details about the boot process of units (services, mount points, devices, sockets).

- List time of each unit to start up:
systemd-analyze blame

- Print a tree of the time critical chain of units:
systemd-analyze critical-chain

- Create an SVG file showing when each system service started, highlighting the time that they spent on initialization:
systemd-analyze plot &gt; {{path/to/file.svg}}

- Plot a dependency graph and convert it to an SVG file:
systemd-analyze dot | dot -T{{svg}} &gt; {{path/to/file.svg}}
</code></pre>
<p>用后两个命令生成图片，用 <code>scp ubuntu@168.138.53.159:/home/ubuntu/dependency.svg .</code>命令复制到本地查看。</p>
<p><img src=/img/2021-05-25-services-init-time.svg alt=各服务启动耗时></p>
<p><img src=/img/2021-05-25-services-dependency.svg alt=各服务依赖></p>
<p>依赖图看吐了，图是用 Graphviz 生成的，也可以用Graphviz过滤掉不要的，太晚了不弄了，源头是“*.slice”。至于它是怎么启动的就没再查下去了，有机会的话系统地看下 systemd<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。生成依赖图的源文件是<a href=/file/2021-05-25-services-dependency.dot>2021-05-25-services-dependency.dot</a>。</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<ul>
<li><input disabled type=checkbox> 系统地分析 systemd。</li>
</ul>
&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li>
</ol>
</section>
</div>
</article>
<div class=pagination>
<div class=prev> <a href=https://475300.github.io/%E5%BC%80%E5%8F%91/%E9%85%8D%E7%BD%AEoracle-vps/>Previous Post</a> </div>
</div>
</main><footer class=site-footer>
<span class=left>
<a href=/authors>Authors</a>
.
<a href=/tags>Tags</a>
</span>
<span class=right>
<em>乐土为家</em>
</span>
</footer>
</body>
</html>